<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬1è¯¾: é£é™©ä»·å€¼(VaR)æ¨¡å‹ - Pythoné‡‘èç¼–ç¨‹è¯¾ç¨‹</title>
    <link rel="stylesheet" href="../../css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
    /* ç¡®ä¿ä»£ç å—å·¦å¯¹é½ */
    .lesson-content pre {
        text-align: left !important;
        font-family: 'Courier New', Courier, monospace;
        background-color: #f5f7fa;
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 20px 0;
        border-left: 4px solid #4299e1;
    }
    
    .lesson-content code {
        text-align: left !important;
        font-family: 'Courier New', Courier, monospace;
        background-color: #f5f7fa;
        padding: 2px 5px;
        border-radius: 3px;
    }
    
    /* ç¡®ä¿preæ ‡ç­¾å†…çš„å†…å®¹å·¦å¯¹é½ */
    pre * {
        text-align: left !important;
    }
    
    /* ç¡®ä¿æ‰€æœ‰ä»£ç ç›¸å…³å…ƒç´ éƒ½å·¦å¯¹é½ */
    pre, code, .hljs {
        text-align: left !important;
    }
    
    /* VaRäº¤äº’æ¼”ç¤ºæ ·å¼ */
    .var-demo {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin: 30px 0;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    }
    
    .demo-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .control-group {
        background: rgba(255,255,255,0.1);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .control-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
    }
    
    .control-group input[type="range"] {
        width: 100%;
        margin: 5px 0;
    }
    
    .control-group input[type="number"] {
        width: 80px;
        padding: 5px 8px;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 5px;
        background: rgba(255,255,255,0.2);
        color: white;
        font-size: 14px;
    }
    
    .var-chart {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 6px 25px rgba(0,0,0,0.1);
        min-height: 400px;
    }
    
    .metrics-display {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    
    .metric-card {
        background: rgba(255,255,255,0.15);
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .metric-value {
        font-size: 24px;
        font-weight: bold;
        margin: 5px 0;
    }
    
    .metric-label {
        font-size: 12px;
        opacity: 0.9;
    }
    
    .demo-button {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 2px solid rgba(255,255,255,0.3);
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        margin: 5px;
    }
    
    .demo-button:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    
    .demo-button.active {
        background: rgba(255,255,255,0.4);
        border-color: rgba(255,255,255,0.6);
    }
    
    .tooltip {
        position: absolute;
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 13px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 1000;
        max-width: 200px;
    }
    
    .method-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .method-card {
        background: rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .method-card h4 {
        margin-top: 0;
        color: #ffd700;
    }
    </style>
    
</head>
<body>
<div id="navigation-container"></div>
<script>
// åŠ¨æ€åŠ è½½å¯¼èˆªæ¡
function loadNavigation() {
    fetch('../../nav.html')
        .then(response => response.text())
        .then(html => {
            // æ›´æ–°å¯¼èˆªä¸­çš„é“¾æ¥è·¯å¾„
            let updatedHtml = html;
            
            // å¤„ç†æ ¹ç›®å½•æ–‡ä»¶é“¾æ¥ï¼ˆindex.html, syllabus.htmlç­‰ï¼‰
            updatedHtml = updatedHtml.replace(/href="index\.html"/g, 'href="../../index.html"');
            updatedHtml = updatedHtml.replace(/href="\.\/([^/]*\.html)"/g, 'href="../../$1"');
            
            // å¤„ç†æ¨¡å—è·¯å¾„é“¾æ¥ï¼ˆå·²ç»æ˜¯å®Œæ•´ç›¸å¯¹è·¯å¾„ï¼Œåªéœ€è¦æ·»åŠ æ ¹è·¯å¾„å‰ç¼€ï¼‰
            updatedHtml = updatedHtml.replace(/href="\.\/part([^"]*)"/g, 'href="../../part$1"');
            
            document.getElementById('navigation-container').innerHTML = updatedHtml;
            
            // æ·»åŠ ç§»åŠ¨ç«¯èœå•åˆ‡æ¢åŠŸèƒ½
            const menuToggle = document.getElementById('menuToggle');
            const navMenu = document.querySelector('.nav-menu');
            if (menuToggle && navMenu) {
                menuToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }
        })
        .catch(error => console.error('å¯¼èˆªåŠ è½½å¤±è´¥:', error));
}

// é¡µé¢åŠ è½½å®ŒæˆååŠ è½½å¯¼èˆª
document.addEventListener('DOMContentLoaded', loadNavigation);
</script>



<main class="container">
        <section class="lesson-content">
            <h2>é£é™©ä»·å€¼(VaR)æ¦‚è¿°</h2>
            <p>é£é™©ä»·å€¼(Value at Risk, VaR)æ˜¯åœ¨æ­£å¸¸å¸‚åœºæ¡ä»¶ä¸‹ï¼ŒæŸä¸€ç‰¹å®šæ—¶é—´æ®µå’Œç½®ä¿¡æ°´å¹³ä¸‹ï¼ŒæŠ•èµ„ç»„åˆå¯èƒ½é­å—çš„æœ€å¤§æŸå¤±ã€‚</p>
            <div class="math-theory">
                <h3>æ•°å­¦ç†è®ºåŸºç¡€</h3>
                <h4>1. VaRçš„æ•°å­¦å®šä¹‰</h4>
                <p>å¯¹äºæŠ•èµ„ç»„åˆçš„æŸå¤±åˆ†å¸ƒ \(L\)ï¼Œåœ¨ç½®ä¿¡æ°´å¹³ \(\alpha\) ä¸‹çš„VaRå®šä¹‰ä¸ºï¼š</p>
                <div class="formula">
                    \[VaR_\alpha = \inf\{l \in \mathbb{R} : P(L > l) \leq 1-\alpha\}\]
                </div>
                <p>å³æ»¡è¶³ \(P(L \leq VaR_\alpha) = \alpha\) çš„åˆ†ä½æ•°ã€‚</p>
                <h4>2. å‚æ•°æ³•VaRï¼ˆæ­£æ€åˆ†å¸ƒå‡è®¾ï¼‰</h4>
                <p>å‡è®¾æ”¶ç›Šç‡æœä»æ­£æ€åˆ†å¸ƒ \(R \sim N(\mu, \sigma^2)\)ï¼Œåˆ™ï¼š</p>
                <div class="formula">
                    \[VaR_\alpha = -(\mu + \sigma \cdot \Phi^{-1}(1-\alpha)) \cdot V_0\]
                </div>
                <p>å…¶ä¸­ï¼š</p>
                <ul>
                    <li>\(\mu\) ä¸ºæœŸæœ›æ”¶ç›Šç‡</li>
                    <li>\(\sigma\) ä¸ºæ”¶ç›Šç‡æ ‡å‡†å·®</li>
                    <li>\(\Phi^{-1}\) ä¸ºæ ‡å‡†æ­£æ€åˆ†å¸ƒçš„é€†ç´¯ç§¯åˆ†å¸ƒå‡½æ•°</li>
                    <li>\(V_0\) ä¸ºæŠ•èµ„ç»„åˆåˆå§‹ä»·å€¼</li>
                </ul>
                <h4>3. å†å²æ¨¡æ‹Ÿæ³•</h4>
                <p>åŸºäºå†å²æ”¶ç›Šç‡æ•°æ® \(\{r_1, r_2, ..., r_n\}\)ï¼ŒVaRä¸ºï¼š</p>
                <div class="formula">
                    \[VaR_\alpha = -r_{(k)} \cdot V_0\]
                </div>
                <p>å…¶ä¸­ \(r_{(k)}\) æ˜¯ç¬¬ \(k\) ä¸ªé¡ºåºç»Ÿè®¡é‡ï¼Œ\(k = \lfloor n(1-\alpha) \rfloor\)ã€‚</p>
                <h4>4. è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿæ³•</h4>
                <p>é€šè¿‡æ¨¡æ‹Ÿ \(N\) æ¬¡è·¯å¾„ï¼Œå¾—åˆ°æŸå¤±åˆ†å¸ƒçš„æ ·æœ¬ \(\{L_1, L_2, ..., L_N\}\)ï¼š</p>
                <div class="formula">
                    \[VaR_\alpha \approx L_{(k)}\]
                </div>
                <p>å…¶ä¸­ \(L_{(k)}\) æ˜¯ç¬¬ \(k\) ä¸ªé¡ºåºç»Ÿè®¡é‡ï¼Œ\(k = \lfloor N(1-\alpha) \rfloor\)ã€‚</p>
                <h4>5. æ¡ä»¶é£é™©ä»·å€¼(CVaR)</h4>
                <p>CVaRï¼ˆä¹Ÿç§°ä¸ºæœŸæœ›æŸå¤±ESï¼‰å®šä¹‰ä¸ºè¶…è¿‡VaRçš„æ¡ä»¶æœŸæœ›æŸå¤±ï¼š</p>
                <div class="formula">
                    \[CVaR_\alpha = E[L | L > VaR_\alpha] = \frac{1}{1-\alpha} \int_{VaR_\alpha}^{\infty} l \cdot f_L(l) dl\]
                </div>
                <h4>6. æŠ•èµ„ç»„åˆVaR</h4>
                <p>å¯¹äºå¤šèµ„äº§æŠ•èµ„ç»„åˆï¼Œæƒé‡å‘é‡ä¸º \(\mathbf{w}\)ï¼Œåæ–¹å·®çŸ©é˜µä¸º \(\mathbf{\Sigma}\)ï¼š</p>
                <div class="formula">
                    \[\sigma_p = \sqrt{\mathbf{w}^T \mathbf{\Sigma} \mathbf{w}}\]
                </div>
                <div class="formula">
                    \[VaR_\alpha = -(\mu_p + \sigma_p \cdot \Phi^{-1}(1-\alpha)) \cdot V_0\]
                </div>
                <p>å…¶ä¸­ \(\mu_p = \mathbf{w}^T \boldsymbol{\mu}\) ä¸ºæŠ•èµ„ç»„åˆæœŸæœ›æ”¶ç›Šç‡ã€‚</p>
            </div>
            <h3>1. VaRçš„åŸºæœ¬æ¦‚å¿µ</h3>
            <pre><code class="language-python">import numpy as np
import pandas as pd
from scipy.stats import norm
def calculate_var(returns, confidence_level=0.95):
    """è®¡ç®—åœ¨é™©ä»·å€¼(VaR)"""
    if isinstance(returns, pd.DataFrame):
        return returns.aggregate(calculate_var, confidence_level=confidence_level)
    elif isinstance(returns, pd.Series):
        return -np.percentile(returns, 100 * (1 - confidence_level))
    else:
        raise TypeError("è¾“å…¥åº”ä¸ºPandas Seriesæˆ–DataFrame")
# ç¤ºä¾‹æ”¶ç›Šç‡æ•°æ®
returns = pd.Series([0.01, -0.02, 0.03, -0.01, 0.02, -0.03, 0.01, -0.02])
var_95 = calculate_var(returns)
print(f"95%ç½®ä¿¡æ°´å¹³çš„VaR: {var_95:.4f}")</code></pre>
            
            <div class="var-demo">
                <h4>ğŸ¯ VaRè®¡ç®—æ–¹æ³•æ¯”è¾ƒ</h4>
                <p>æ¯”è¾ƒä¸åŒVaRè®¡ç®—æ–¹æ³•çš„ç»“æœï¼Œç†è§£å„ç§æ–¹æ³•çš„ä¼˜ç¼ºç‚¹</p>
                
                <div class="demo-controls">
                    <div class="control-group">
                        <label>ç½®ä¿¡æ°´å¹³ (%)</label>
                        <input type="range" id="confidenceLevel" min="90" max="99" value="95" step="1" oninput="updateVaRCalculation()">
                        <input type="number" id="confidenceLevelNum" min="90" max="99" value="95" onchange="updateVaRCalculation()">
                    </div>
                    <div class="control-group">
                        <label>æ•°æ®ç‚¹æ•°é‡</label>
                        <input type="range" id="dataPoints" min="100" max="1000" value="252" oninput="updateVaRCalculation()">
                        <input type="number" id="dataPointsNum" min="100" max="1000" value="252" onchange="updateVaRCalculation()">
                    </div>
                    <div class="control-group">
                        <label>æ³¢åŠ¨ç‡ (%)</label>
                        <input type="range" id="volatility" min="10" max="50" value="20" oninput="updateVaRCalculation()">
                        <input type="number" id="volatilityNum" min="10" max="50" value="20" onchange="updateVaRCalculation()">
                    </div>
                    <div class="control-group">
                        <button class="demo-button" onclick="generateNewData()">ç”Ÿæˆæ–°æ•°æ®</button>
                        <button class="demo-button" onclick="toggleDistribution()">åˆ‡æ¢åˆ†å¸ƒ</button>
                    </div>
                </div>
                
                <div class="var-chart">
                    <div id="varComparison"></div>
                </div>
                
                <div class="method-comparison">
                    <div class="method-card">
                        <h4>ğŸ“Š å‚æ•°æ³•VaR</h4>
                        <div class="metric-value" id="parametricVaR">--</div>
                        <p>å‡è®¾æ”¶ç›Šç‡æœä»æ­£æ€åˆ†å¸ƒ</p>
                    </div>
                    <div class="method-card">
                        <h4>ğŸ“ˆ å†å²æ¨¡æ‹Ÿæ³•VaR</h4>
                        <div class="metric-value" id="historicalVaR">--</div>
                        <p>åŸºäºå†å²æ•°æ®åˆ†ä½æ•°</p>
                    </div>
                    <div class="method-card">
                        <h4>ğŸ² è’™ç‰¹å¡æ´›VaR</h4>
                        <div class="metric-value" id="monteCarloVaR">--</div>
                        <p>é€šè¿‡éšæœºæ¨¡æ‹Ÿè®¡ç®—</p>
                    </div>
                </div>
                
                <div class="metrics-display">
                    <div class="metric-card">
                        <div class="metric-value" id="cvar">--</div>
                        <div class="metric-label">æ¡ä»¶VaR (CVaR)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="maxLoss">--</div>
                        <div class="metric-label">æœ€å¤§æŸå¤±</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgReturn">--</div>
                        <div class="metric-label">å¹³å‡æ”¶ç›Šç‡ (%)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="stdDev">--</div>
                        <div class="metric-label">æ ‡å‡†å·® (%)</div>
                    </div>
                </div>
            </div>
            
            <div class="var-demo">
                <h4>ğŸ“Š VaRå›æµ‹åˆ†æ</h4>
                <p>éªŒè¯VaRæ¨¡å‹çš„å‡†ç¡®æ€§ï¼Œåˆ†æè¿çº¦æ¬¡æ•°å’Œèšé›†æ€§</p>
                
                <div class="demo-controls">
                    <div class="control-group">
                        <label>å›æµ‹æœŸé—´ï¼ˆå¤©ï¼‰</label>
                        <input type="range" id="backtestDays" min="100" max="500" value="252" oninput="updateBacktest()">
                        <input type="number" id="backtestDaysNum" min="100" max="500" value="252" onchange="updateBacktest()">
                    </div>
                    <div class="control-group">
                        <label>VaRæ–¹æ³•</label>
                        <select id="varMethod" onchange="updateBacktest()" style="width: 100%; padding: 8px; border-radius: 5px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                            <option value="parametric">å‚æ•°æ³•</option>
                            <option value="historical">å†å²æ¨¡æ‹Ÿæ³•</option>
                            <option value="montecarlo">è’™ç‰¹å¡æ´›æ³•</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button class="demo-button" onclick="runBacktest()">è¿è¡Œå›æµ‹</button>
                        <button class="demo-button" onclick="resetBacktest()">é‡ç½®</button>
                    </div>
                </div>
                
                <div class="var-chart">
                    <div id="backtestChart"></div>
                </div>
                
                <div class="metrics-display">
                    <div class="metric-card">
                        <div class="metric-value" id="violationRate">--</div>
                        <div class="metric-label">è¿çº¦ç‡ (%)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="expectedViolations">--</div>
                        <div class="metric-label">é¢„æœŸè¿çº¦æ¬¡æ•°</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="actualViolations">--</div>
                        <div class="metric-label">å®é™…è¿çº¦æ¬¡æ•°</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="kupiecTest">--</div>
                        <div class="metric-label">Kupiecæ£€éªŒpå€¼</div>
                    </div>
                </div>
            </div>
            <h3>2. VaRçš„å‚æ•°é€‰æ‹©</h3>
            <pre><code class="language-python"># ä¸åŒç½®ä¿¡æ°´å¹³çš„VaRæ¯”è¾ƒ
confidence_levels = [0.90, 0.95, 0.99]
var_results = {cl: calculate_var(returns, cl) for cl in confidence_levels}
print("\nä¸åŒç½®ä¿¡æ°´å¹³çš„VaR:")
for cl, var in var_results.items():
    print(f"{int(cl*100)}% VaR: {var:.4f}")</code></pre>
        </section>
        <section class="lesson-content">
            <h2>å†å²æ¨¡æ‹Ÿæ³•</h2>
            <p>å†å²æ¨¡æ‹Ÿæ³•ä½¿ç”¨å†å²æ”¶ç›Šç‡åˆ†å¸ƒç›´æ¥è®¡ç®—VaRï¼Œæ— éœ€å¯¹æ”¶ç›Šç‡åˆ†å¸ƒåšä»»ä½•å‡è®¾ã€‚</p>
            <h3>1. åŸºæœ¬å†å²æ¨¡æ‹Ÿæ³•</h3>
            <pre><code class="language-python">def historical_var(returns, confidence_level=0.95, window=252):
    """å†å²æ¨¡æ‹Ÿæ³•è®¡ç®—VaR"""
    if len(returns) < window:
        raise ValueError("æ”¶ç›Šç‡æ•°æ®é•¿åº¦å°äºçª—å£å¤§å°")
    # è®¡ç®—æ»šåŠ¨çª—å£VaR
    var_series = returns.rolling(window).apply(
        lambda x: -np.percentile(x, 100 * (1 - confidence_level))
    )
    return var_series.dropna()
# ç”Ÿæˆæ›´é•¿çš„æ”¶ç›Šç‡åºåˆ—ç”¨äºæ¼”ç¤º
np.random.seed(42)
long_returns = pd.Series(np.random.normal(0.001, 0.02, 1000))
# è®¡ç®—æ»šåŠ¨VaR
rolling_var = historical_var(long_returns)
print("\næ»šåŠ¨å†å²VaRçš„æœ€å5ä¸ªå€¼:\n", rolling_var.tail())</code></pre>
            <h3>2. åŠ æƒå†å²æ¨¡æ‹Ÿæ³•</h3>
            <pre><code class="language-python">def weighted_historical_var(returns, confidence_level=0.95, decay=0.99):
    """åŠ æƒå†å²æ¨¡æ‹Ÿæ³•è®¡ç®—VaR"""
    weights = np.array([decay ** i for i in range(len(returns))][::-1])
    weights = weights / weights.sum()
    sorted_returns = np.sort(returns)
    cum_weights = np.cumsum(weights)
    # æ‰¾åˆ°ç¬¬ä¸€ä¸ªè¶…è¿‡(1-confidence_level)çš„æƒé‡ä½ç½®
    idx = np.argmax(cum_weights >= (1 - confidence_level))
    return -sorted_returns[idx]
weighted_var = weighted_historical_var(returns)
print(f"\nåŠ æƒå†å²VaR: {weighted_var:.4f}")</code></pre>
        </section>
        <section class="lesson-content">
            <h2>æ–¹å·®-åæ–¹å·®æ³•</h2>
            <p>æ–¹å·®-åæ–¹å·®æ³•å‡è®¾æ”¶ç›Šç‡æœä»æ­£æ€åˆ†å¸ƒï¼Œåˆ©ç”¨å‡å€¼å’Œæ–¹å·®è®¡ç®—VaRã€‚</p>
            <h3>1. å•èµ„äº§VaRè®¡ç®—</h3>
            <pre><code class="language-python">def parametric_var(returns, confidence_level=0.95, mean_adjust=True):
    """æ–¹å·®-åæ–¹å·®æ³•è®¡ç®—VaR"""
    if mean_adjust:
        mu = returns.mean()
    else:
        mu = 0
    sigma = returns.std()
    alpha = norm.ppf(1 - confidence_level)
    return -(mu + alpha * sigma)
parametric_var_95 = parametric_var(returns)
print(f"\næ–¹å·®-åæ–¹å·®æ³•95% VaR: {parametric_var_95:.4f}")</code></pre>
            <h3>2. æŠ•èµ„ç»„åˆVaRè®¡ç®—</h3>
            <pre><code class="language-python">def portfolio_parametric_var(weights, expected_returns, cov_matrix,
                           confidence_level=0.95, portfolio_value=1):
    """æŠ•èµ„ç»„åˆçš„æ–¹å·®-åæ–¹å·®æ³•VaR"""
    port_return = np.dot(weights, expected_returns)
    port_volatility = np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights)))
    alpha = norm.ppf(1 - confidence_level)
    return -(port_return + alpha * port_volatility) * portfolio_value
# ç¤ºä¾‹æŠ•èµ„ç»„åˆ
weights = np.array([0.4, 0.3, 0.3])
expected_returns = np.array([0.01, 0.015, 0.02])
cov_matrix = np.array([
    [0.04, 0.002, 0.001],
    [0.002, 0.09, 0.003],
    [0.001, 0.003, 0.16]
])
port_var = portfolio_parametric_var(weights, expected_returns, cov_matrix)
print(f"\næŠ•èµ„ç»„åˆ95% VaR: {port_var:.4f}")</code></pre>
        </section>
        <section class="lesson-content">
            <h2>è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿæ³•</h2>
            <p>è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿæ³•é€šè¿‡æ¨¡æ‹Ÿå¤§é‡å¯èƒ½çš„æœªæ¥æƒ…æ™¯æ¥è®¡ç®—VaRã€‚</p>
            <h3>1. å•èµ„äº§è’™ç‰¹å¡æ´›VaR</h3>
            <pre><code class="language-python">def monte_carlo_var(returns, confidence_level=0.95, n_simulations=10000,
                   n_days=1, random_seed=None):
    """è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿæ³•è®¡ç®—VaR"""
    if random_seed is not None:
        np.random.seed(random_seed)
    mu = returns.mean()
    sigma = returns.std()
    # æ¨¡æ‹Ÿæœªæ¥æ”¶ç›Šç‡
    simulated_returns = np.random.normal(mu, sigma, (n_simulations, n_days))
    portfolio_paths = (1 + simulated_returns).cumprod(axis=1)
    # è®¡ç®—æœ€ç»ˆä»·å€¼åˆ†å¸ƒ
    final_values = portfolio_paths[:, -1]
    var = -np.percentile(final_values - 1, 100 * (1 - confidence_level))
    return var
mc_var = monte_carlo_var(returns, random_seed=42)
print(f"\nè’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ95% VaR: {mc_var:.4f}")</code></pre>
            <h3>2. å¤šèµ„äº§æŠ•èµ„ç»„åˆè’™ç‰¹å¡æ´›VaR</h3>
            <pre><code class="language-python">def portfolio_monte_carlo_var(weights, expected_returns, cov_matrix,
                            confidence_level=0.95, n_simulations=10000,
                            n_days=1, portfolio_value=1, random_seed=None):
    """æŠ•èµ„ç»„åˆçš„è’™ç‰¹å¡æ´›VaR"""
    if random_seed is not None:
        np.random.seed(random_seed)
    n_assets = len(weights)
    # ç”Ÿæˆç›¸å…³éšæœºæ•°
    L = np.linalg.cholesky(cov_matrix)
    uncorrelated = np.random.normal(size=(n_simulations, n_days, n_assets))
    correlated = np.dot(uncorrelated, L.T)
    # æ·»åŠ æ¼‚ç§»é¡¹
    drift = expected_returns - 0.5 * np.diag(cov_matrix)
    paths = np.exp(drift + correlated).cumprod(axis=1)
    # è®¡ç®—ç»„åˆä»·å€¼
    portfolio_paths = np.dot(paths, weights) * portfolio_value
    final_values = portfolio_paths[:, -1]
    # è®¡ç®—VaR
    var = -np.percentile(final_values - portfolio_value, 100 * (1 - confidence_level))
    return var
port_mc_var = portfolio_monte_carlo_var(weights, expected_returns, cov_matrix, random_seed=42)
print(f"æŠ•èµ„ç»„åˆè’™ç‰¹å¡æ´›95% VaR: {port_mc_var:.4f}")</code></pre>
        </section>
        <section class="lesson-content">
            <h2>VaRæ¨¡å‹çš„éªŒè¯ä¸åº”ç”¨</h2>
            <p>VaRæ¨¡å‹çš„éªŒè¯å’Œå®é™…åº”ç”¨ä¸­çš„æ³¨æ„äº‹é¡¹ã€‚</p>
            <h3>1. è¿”å›æµ‹è¯•(Backtesting)</h3>
            <pre><code class="language-python">def var_backtest(returns, var_series, confidence_level=0.95):
    """VaRæ¨¡å‹è¿”å›æµ‹è¯•"""
    exceptions = returns < -var_series
    n_exceptions = exceptions.sum()
    n_observations = len(returns)
    expected_exceptions = (1 - confidence_level) * n_observations
    print(f"\nè¿”å›æµ‹è¯•ç»“æœ:")
    print(f"è§‚å¯ŸæœŸæ•°: {n_observations}")
    print(f"é¢„æœŸä¾‹å¤–æ•°: {expected_exceptions:.1f}")
    print(f"å®é™…ä¾‹å¤–æ•°: {n_exceptions}")
    print(f"ä¾‹å¤–æ¯”ä¾‹: {n_exceptions/n_observations:.4f}")
    return exceptions
# ä½¿ç”¨ä¹‹å‰è®¡ç®—çš„æ»šåŠ¨VaRè¿›è¡Œæµ‹è¯•
exceptions = var_backtest(long_returns[-len(rolling_var):], rolling_var)</code></pre>
            <h3>2. VaRçš„ä¼˜ç¼ºç‚¹</h3>
            <pre><code class="language-python"># VaRçš„ä¼˜ç‚¹å’Œç¼ºç‚¹æ€»ç»“
var_pros_cons = {
    'ä¼˜ç‚¹': [
        'ç›´è§‚æ˜“æ‡‚çš„é£é™©åº¦é‡',
        'é€‚ç”¨äºä¸åŒèµ„äº§ç±»åˆ«',
        'ä¾¿äºæ¯”è¾ƒä¸åŒæŠ•èµ„ç»„åˆé£é™©',
        'å¯ç”¨äºé£é™©é™é¢ç®¡ç†'
    ],
    'ç¼ºç‚¹': [
        'ä¸æ»¡è¶³æ¬¡å¯åŠ æ€§(éä¸€è‡´æ€§é£é™©åº¦é‡)',
        'å¯¹å°¾éƒ¨é£é™©æè¿°ä¸è¶³',
        'ä¾èµ–å†å²æ•°æ®å’Œåˆ†å¸ƒå‡è®¾',
        'ä¸åŒè®¡ç®—æ–¹æ³•ç»“æœå·®å¼‚å¤§'
    ]
}
print("\nVaRæ¨¡å‹çš„ä¼˜ç¼ºç‚¹:")
for category, items in var_pros_cons.items():
    print(f"\n{category}:")
    for item in items:
        print(f"- {item}")</code></pre>
        </section>
        <div class="lesson-navigation">
            <a href="../../index.html" class="btn">Â« è¿”å›æ¨¡å—æ¦‚è§ˆ</a>
            <a href="lesson2.html" class="btn">ä¸‹ä¸€è¯¾: æ¡ä»¶é£é™©ä»·å€¼(CVaR) Â»</a>
        </div>
    </main>
    <footer>
        <div class="container">
            <p>Â© 2023 Pythoné‡‘èç¼–ç¨‹è¯¾ç¨‹. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
        </div>
    </footer>
    
    <script>
    // VaRæ¼”ç¤ºç›¸å…³å˜é‡
    let currentData = [];
    let currentDistribution = 'normal';
    let backtestData = [];
    let varValues = [];
    
    // ç”Ÿæˆéšæœºæ•°æ®
    function generateRandomData(n, volatility, distribution = 'normal') {
        const data = [];
        const vol = volatility / 100;
        
        for (let i = 0; i < n; i++) {
            let value;
            if (distribution === 'normal') {
                value = d3.randomNormal(0, vol)();
            } else {
                // tåˆ†å¸ƒï¼ˆæ›´åšå°¾ï¼‰
                value = d3.randomNormal(0, vol)() * Math.sqrt(5/3);
                if (Math.random() < 0.1) {
                    value *= 2; // å¢åŠ æç«¯å€¼æ¦‚ç‡
                }
            }
            data.push(value);
        }
        return data;
    }
    
    // è®¡ç®—å‚æ•°æ³•VaR
    function calculateParametricVaR(data, confidence) {
        const mean = d3.mean(data);
        const std = d3.deviation(data);
        const z = getZScore(confidence);
        return -(mean + z * std);
    }
    
    // è®¡ç®—å†å²æ¨¡æ‹Ÿæ³•VaR
    function calculateHistoricalVaR(data, confidence) {
        const sorted = [...data].sort((a, b) => a - b);
        const index = Math.floor((1 - confidence / 100) * sorted.length);
        return -sorted[index];
    }
    
    // è®¡ç®—è’™ç‰¹å¡æ´›VaR
    function calculateMonteCarloVaR(data, confidence, simulations = 10000) {
        const mean = d3.mean(data);
        const std = d3.deviation(data);
        const simulated = [];
        
        for (let i = 0; i < simulations; i++) {
            simulated.push(d3.randomNormal(mean, std)());
        }
        
        return calculateHistoricalVaR(simulated, confidence);
    }
    
    // è®¡ç®—CVaR
    function calculateCVaR(data, confidence) {
        const sorted = [...data].sort((a, b) => a - b);
        const cutoff = Math.floor((1 - confidence / 100) * sorted.length);
        const tailLosses = sorted.slice(0, cutoff);
        return -d3.mean(tailLosses);
    }
    
    // è·å–Zåˆ†æ•°
    function getZScore(confidence) {
        const p = confidence / 100;
        // è¿‘ä¼¼æ­£æ€åˆ†å¸ƒåˆ†ä½æ•°
        if (p === 0.95) return 1.645;
        if (p === 0.99) return 2.326;
        if (p === 0.975) return 1.96;
        if (p === 0.90) return 1.282;
        // ç®€åŒ–è¿‘ä¼¼
        return Math.sqrt(2) * Math.sqrt(-Math.log(2 * (1 - p)));
    }
    
    // ç»˜åˆ¶VaRæ¯”è¾ƒå›¾è¡¨
    function drawVaRComparison() {
        const container = d3.select('#varComparison');
        container.selectAll('*').remove();
        
        const margin = {top: 20, right: 30, bottom: 40, left: 50};
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.bottom - margin.top;
        
        const svg = container.append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.bottom + margin.top);
            
        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        // åˆ›å»ºç›´æ–¹å›¾
        const x = d3.scaleLinear()
            .domain(d3.extent(currentData))
            .range([0, width]);
            
        const histogram = d3.histogram()
            .value(d => d)
            .domain(x.domain())
            .thresholds(x.ticks(30));
            
        const bins = histogram(currentData);
        
        const y = d3.scaleLinear()
            .domain([0, d3.max(bins, d => d.length)])
            .range([height, 0]);
        
        // ç»˜åˆ¶ç›´æ–¹å›¾
        g.selectAll('.bar')
            .data(bins)
            .enter().append('rect')
            .attr('class', 'bar')
            .attr('x', d => x(d.x0))
            .attr('width', d => x(d.x1) - x(d.x0) - 1)
            .attr('y', d => y(d.length))
            .attr('height', d => height - y(d.length))
            .attr('fill', '#69b3a2')
            .attr('opacity', 0.7);
        
        // è®¡ç®—VaRå€¼
        const confidence = +document.getElementById('confidenceLevel').value;
        const parametricVaR = calculateParametricVaR(currentData, confidence);
        const historicalVaR = calculateHistoricalVaR(currentData, confidence);
        const monteCarloVaR = calculateMonteCarloVaR(currentData, confidence);
        
        // ç»˜åˆ¶VaRçº¿
        const varLines = [
            {value: parametricVaR, color: '#ff6b6b', label: 'å‚æ•°æ³•'},
            {value: historicalVaR, color: '#4ecdc4', label: 'å†å²æ¨¡æ‹Ÿæ³•'},
            {value: monteCarloVaR, color: '#45b7d1', label: 'è’™ç‰¹å¡æ´›æ³•'}
        ];
        
        varLines.forEach((line, i) => {
            g.append('line')
                .attr('x1', x(-line.value))
                .attr('x2', x(-line.value))
                .attr('y1', 0)
                .attr('y2', height)
                .attr('stroke', line.color)
                .attr('stroke-width', 3)
                .attr('stroke-dasharray', '5,5');
                
            g.append('text')
                .attr('x', x(-line.value))
                .attr('y', -5 + i * 15)
                .attr('text-anchor', 'middle')
                .attr('fill', line.color)
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text(`${line.label}: ${(line.value * 100).toFixed(2)}%`);
        });
        
        // æ·»åŠ åæ ‡è½´
        g.append('g')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(x).tickFormat(d => `${(d * 100).toFixed(1)}%`));
            
        g.append('g')
            .call(d3.axisLeft(y));
        
        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        document.getElementById('parametricVaR').textContent = `${(parametricVaR * 100).toFixed(2)}%`;
        document.getElementById('historicalVaR').textContent = `${(historicalVaR * 100).toFixed(2)}%`;
        document.getElementById('monteCarloVaR').textContent = `${(monteCarloVaR * 100).toFixed(2)}%`;
        
        const cvar = calculateCVaR(currentData, confidence);
        document.getElementById('cvar').textContent = `${(cvar * 100).toFixed(2)}%`;
        document.getElementById('maxLoss').textContent = `${(Math.min(...currentData) * 100).toFixed(2)}%`;
        document.getElementById('avgReturn').textContent = `${(d3.mean(currentData) * 100).toFixed(2)}%`;
        document.getElementById('stdDev').textContent = `${(d3.deviation(currentData) * 100).toFixed(2)}%`;
    }
    
    // ç»˜åˆ¶å›æµ‹å›¾è¡¨
    function drawBacktestChart() {
        const container = d3.select('#backtestChart');
        container.selectAll('*').remove();
        
        if (backtestData.length === 0) {
            container.append('div')
                .style('text-align', 'center')
                .style('padding', '50px')
                .style('color', '#666')
                .text('ç‚¹å‡»"è¿è¡Œå›æµ‹"å¼€å§‹åˆ†æ');
            return;
        }
        
        const margin = {top: 20, right: 30, bottom: 40, left: 50};
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.bottom - margin.top;
        
        const svg = container.append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.bottom + margin.top);
            
        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        const x = d3.scaleLinear()
            .domain([0, backtestData.length - 1])
            .range([0, width]);
            
        const y = d3.scaleLinear()
            .domain(d3.extent([...backtestData, ...varValues]))
            .range([height, 0]);
        
        // ç»˜åˆ¶æ”¶ç›Šç‡çº¿
        const line = d3.line()
            .x((d, i) => x(i))
            .y(d => y(d));
            
        g.append('path')
            .datum(backtestData)
            .attr('fill', 'none')
            .attr('stroke', '#69b3a2')
            .attr('stroke-width', 2)
            .attr('d', line);
        
        // ç»˜åˆ¶VaRçº¿
        g.append('path')
            .datum(varValues)
            .attr('fill', 'none')
            .attr('stroke', '#ff6b6b')
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '5,5')
            .attr('d', line);
        
        // æ ‡è®°è¿çº¦ç‚¹
        const violations = backtestData.map((d, i) => d < -varValues[i] ? i : null).filter(d => d !== null);
        
        g.selectAll('.violation')
            .data(violations)
            .enter().append('circle')
            .attr('class', 'violation')
            .attr('cx', d => x(d))
            .attr('cy', d => y(backtestData[d]))
            .attr('r', 4)
            .attr('fill', '#e74c3c');
        
        // æ·»åŠ åæ ‡è½´
        g.append('g')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(x));
            
        g.append('g')
            .call(d3.axisLeft(y).tickFormat(d => `${(d * 100).toFixed(1)}%`));
        
        // æ·»åŠ å›¾ä¾‹
        const legend = g.append('g')
            .attr('transform', `translate(${width - 150}, 20)`);
            
        legend.append('line')
            .attr('x1', 0).attr('x2', 20)
            .attr('y1', 0).attr('y2', 0)
            .attr('stroke', '#69b3a2')
            .attr('stroke-width', 2);
            
        legend.append('text')
            .attr('x', 25).attr('y', 5)
            .text('å®é™…æ”¶ç›Šç‡');
            
        legend.append('line')
            .attr('x1', 0).attr('x2', 20)
            .attr('y1', 20).attr('y2', 20)
            .attr('stroke', '#ff6b6b')
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '5,5');
            
        legend.append('text')
            .attr('x', 25).attr('y', 25)
            .text('VaRé˜ˆå€¼');
            
        legend.append('circle')
            .attr('cx', 10).attr('cy', 40)
            .attr('r', 4)
            .attr('fill', '#e74c3c');
            
        legend.append('text')
            .attr('x', 25).attr('y', 45)
            .text('è¿çº¦ç‚¹');
    }
    
    // æ›´æ–°VaRè®¡ç®—
    function updateVaRCalculation() {
        const confidence = +document.getElementById('confidenceLevel').value;
        const dataPoints = +document.getElementById('dataPoints').value;
        const volatility = +document.getElementById('volatility').value;
        
        document.getElementById('confidenceLevelNum').value = confidence;
        document.getElementById('dataPointsNum').value = dataPoints;
        document.getElementById('volatilityNum').value = volatility;
        
        currentData = generateRandomData(dataPoints, volatility, currentDistribution);
        drawVaRComparison();
    }
    
    // ç”Ÿæˆæ–°æ•°æ®
    function generateNewData() {
        updateVaRCalculation();
    }
    
    // åˆ‡æ¢åˆ†å¸ƒ
    function toggleDistribution() {
        currentDistribution = currentDistribution === 'normal' ? 'heavy-tail' : 'normal';
        const button = event.target;
        button.textContent = currentDistribution === 'normal' ? 'åˆ‡æ¢åˆ†å¸ƒ (æ­£æ€)' : 'åˆ‡æ¢åˆ†å¸ƒ (åšå°¾)';
        updateVaRCalculation();
    }
    
    // è¿è¡Œå›æµ‹
    function runBacktest() {
        const days = +document.getElementById('backtestDays').value;
        const method = document.getElementById('varMethod').value;
        const confidence = +document.getElementById('confidenceLevel').value;
        
        // ç”Ÿæˆå›æµ‹æ•°æ®
        backtestData = generateRandomData(days, 20);
        varValues = [];
        
        // æ»šåŠ¨çª—å£è®¡ç®—VaR
        const windowSize = 60;
        for (let i = windowSize; i < days; i++) {
            const windowData = backtestData.slice(i - windowSize, i);
            let var_value;
            
            switch(method) {
                case 'parametric':
                    var_value = calculateParametricVaR(windowData, confidence);
                    break;
                case 'historical':
                    var_value = calculateHistoricalVaR(windowData, confidence);
                    break;
                case 'montecarlo':
                    var_value = calculateMonteCarloVaR(windowData, confidence);
                    break;
            }
            varValues.push(var_value);
        }
        
        // è®¡ç®—è¿çº¦ç»Ÿè®¡
        const testData = backtestData.slice(windowSize);
        const violations = testData.filter((d, i) => d < -varValues[i]).length;
        const expectedViolations = Math.round(testData.length * (1 - confidence / 100));
        const violationRate = (violations / testData.length * 100);
        
        // Kupiecæ£€éªŒ
        const n = testData.length;
        const x = violations;
        const p = (1 - confidence / 100);
        const lr = 2 * (x * Math.log(x / (n * p)) + (n - x) * Math.log((n - x) / (n * (1 - p))));
        const pValue = 1 - jStat.chisquare.cdf(lr, 1); // ç®€åŒ–è®¡ç®—
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('violationRate').textContent = `${violationRate.toFixed(2)}%`;
        document.getElementById('expectedViolations').textContent = expectedViolations;
        document.getElementById('actualViolations').textContent = violations;
        document.getElementById('kupiecTest').textContent = isNaN(pValue) ? '--' : pValue.toFixed(4);
        
        drawBacktestChart();
    }
    
    // é‡ç½®å›æµ‹
    function resetBacktest() {
        backtestData = [];
        varValues = [];
        document.getElementById('violationRate').textContent = '--';
        document.getElementById('expectedViolations').textContent = '--';
        document.getElementById('actualViolations').textContent = '--';
        document.getElementById('kupiecTest').textContent = '--';
        drawBacktestChart();
    }
    
    // æ›´æ–°å›æµ‹
    function updateBacktest() {
        document.getElementById('backtestDaysNum').value = document.getElementById('backtestDays').value;
        if (backtestData.length > 0) {
            runBacktest();
        }
    }
    
    // ç®€åŒ–çš„jStatå¡æ–¹åˆ†å¸ƒå‡½æ•°
    const jStat = {
        chisquare: {
            cdf: function(x, df) {
                if (x <= 0) return 0;
                if (df === 1) {
                    return 2 * (0.5 - 0.5 * Math.exp(-x/2));
                }
                // ç®€åŒ–è¿‘ä¼¼
                return Math.min(1, x / (df + 2));
            }
        }
    };
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateVaRCalculation();
        drawBacktestChart();
    });
    </script>
</body>
</html>